# Razy v0.5.4

**Post-build 238** | December 2024 – February 2026

A major expansion release introducing multi-database driver support, async threading, cross-distributor bridge commands, FrankenPHP worker mode, repository-based module management, and a comprehensive PHPUnit test suite.

---

## Pipeline System (renamed from FlowManager)

### Class Renames

| Old Name | New Name | Reason |
|----------|----------|--------|
| `FlowManager` | `Pipeline` | Describes the sequential processing pattern |
| `Flow` | `Action` | Describes the unit of work |
| `Transmitter` | `Relay` | Describes the fan-out broadcast behavior |

### Constant Renames

| Old Name | New Name |
|----------|----------|
| `Controller::PLUGIN_FLOWMANAGER` | `Controller::PLUGIN_PIPELINE` |

### Namespace Changes

| Old Namespace | New Namespace |
|---------------|---------------|
| `Razy\FlowManager` | `Razy\Pipeline` |
| `Razy\FlowManager\Action` | `Razy\Pipeline\Action` |
| `Razy\FlowManager\Transmitter` | `Razy\Pipeline\Relay` |

### API Renames

| Old Method | New Method | Description |
|------------|------------|-------------|
| `start()` | `pipe()` | Create and add an action by type |
| `next()` | `then()` | Chain a child action step |
| `append()` | `add()` | Add an existing action instance |
| `resolve()` | `execute()` | Execute actions in the pipeline |
| `request()` | `accept()` | Check if connection is allowed |
| `connect()` | `attachTo()` | Attach action to a parent |
| `join()` | `adopt()` | Adopt a child action |
| `eject()` | `detach()` | Detach from parent |
| `detach(child)` | `remove(child)` | Remove a specific child |
| `kill()` | `terminate()` | Terminate action and children |
| `getParent()` | `findOwner()` | Walk up chain to find parent by type |
| `getFlowManager()` | `getManager()` | Get the root Pipeline |
| `transmit()` | `broadcast()` | Broadcast to all children |
| `isResolved()` | `isExecuted()` | Check if executed |
| `hasFlow()` | `hasChild()` | Check if a child exists |
| `isJoined()` | `isAttached()` | Check attachment status |
| `getFlowType()` | `getActionType()` | Get action type identifier |
| `getTransmitter()` | `getRelay()` | Get the relay instance |
| `getFlows()` | `getActions()` | Get all actions |

### New Methods

| Method | Description |
|--------|-------------|
| `when(bool, callable)` | Conditional pipeline building |
| `tap(callable)` | Side-effect inspection without breaking chain |
| `getChildren()` | Public accessor for child actions |
| `getOwner()` | Get the direct parent entity |

### Directory Moves

| Old Path | New Path |
|----------|----------|
| `src/library/Razy/FlowManager.php` | `src/library/Razy/Pipeline.php` |
| `src/library/Razy/FlowManager/` | `src/library/Razy/Pipeline/` |
| `src/library/Razy/FlowManager/Flow.php` | `src/library/Razy/Pipeline/Action.php` |
| `src/library/Razy/FlowManager/Transmitter.php` | `src/library/Razy/Pipeline/Relay.php` |
| `src/plugins/FlowManager/` | `src/plugins/Pipeline/` |

---

## New Classes

### Database — Multi-Driver Architecture

- **`Database\Driver`** — Abstract base class defining the common interface for database-specific operations (concatenation, limit/offset, auto-increment, upsert syntax)
- **`Database\Driver\MySQL`** — MySQL/MariaDB driver implementation (`CONCAT()`, `AUTO_INCREMENT`, `ON DUPLICATE KEY UPDATE`)
- **`Database\Driver\PostgreSQL`** — PostgreSQL driver implementation (`||` concatenation, `SERIAL`/`BIGSERIAL`, `ON CONFLICT DO UPDATE`)
- **`Database\Driver\SQLite`** — SQLite driver implementation (`||` concatenation, `INTEGER PRIMARY KEY AUTOINCREMENT`, `ON CONFLICT` upsert for 3.24+)
- **`Database\Table\TableHelper`** — Fluent builder for table-level ALTER TABLE SQL (add/modify/drop/rename columns, indexes, foreign keys, table options)
- **`Database\Table\ColumnHelper`** — Fluent builder for column-level ALTER TABLE statements (type, length, nullability, defaults, charset, rename, positioning)

### Networking & Authentication

- **`OAuth2`** — Generic OAuth 2.0 authorization code flow handler (auth URL generation, token exchange, refresh, authenticated API requests via cURL)
- **`Office365SSO`** — Microsoft Entra ID (Azure AD) SSO client extending `OAuth2` (MS Graph API integration, ID token parsing, session management)
- **`SSE`** — Server-Sent Events stream handler (HTTP headers, message formatting, heartbeats, upstream SSE proxy for W3C EventSource protocol)

### Threading & Async

- **`Thread`** — Represents a single managed execution thread (inline callable or async `proc_open` process; tracks status, result, timing, and I/O)
- **`ThreadManager`** — Thread pool manager for async task execution (supports inline synchronous and process-based async modes with concurrency limits)

### Repository & Package Management

- **`RepoInstaller`** — Downloads and installs modules from GitHub repos or custom ZIP URLs (supports versioned releases, branches, tags, and private repo auth)
- **`RepositoryManager`** — Aggregates repository sources (GitHub/custom) for unified module search, index fetching, manifest retrieval, and download URL resolution

### Data & Configuration

- **`YAML`** — Native YAML parser and dumper with no external dependencies (YAML 1.2 subset: mappings, sequences, multi-line strings, flow collections, anchors/aliases)

### Developer Tooling

- **`Tool\LLMCASGenerator`** — Generates LLM-CAS context documents at root, distribution, and module levels using the Razy Template Engine
- **`Tool\ModuleMetadataExtractor`** — Extracts module metadata (package info, API commands, lifecycle events) via static analysis without full framework bootstrap

---

## New CLI Commands

| Command | Purpose |
|---------|---------|
| `bridge` | Executes internal API commands across distributors via JSON payload for inter-process communication |
| `generate-llm-docs` | Generates LLM-CAS documentation files (root, distribution, module) for LLM agent consumption |
| `inspect` | Inspects a distributor's config, domain bindings, loaded modules, and metadata |
| `install` | Downloads and installs modules from GitHub repos, custom URLs, or configured repositories with version/branch control |
| `pack` | Packages a module as a `.phar` archive with manifest/latest metadata for repository publishing |
| `publish` | Generates repository index from packaged modules and optionally pushes to GitHub Releases |
| `routes` | Lists all registered routes, closures, and API commands for a distributor with optional filtering |
| `runapp` | Launches an interactive REPL shell for a distributor, bypassing `sites.inc.php` |
| `search` | Searches for modules across all configured repositories |
| `sync` | Synchronizes modules for a distributor from its `repository.inc.php` configuration |
| `validate` | Validates that route/API closure files exist for a distributor's modules; optionally generates stubs |

---

## Enhanced Classes

### Database

- Added `Database::CreateDriver()` static factory method for instantiating driver objects via `match` expression with alias support
- Added `Database::connectWithDriver()` for connecting with explicit driver type
- Added `Database::getDriver()` and `Database::getDriverType()` accessors
- Added driver type constants: `DRIVER_MYSQL`, `DRIVER_PGSQL`, `DRIVER_SQLITE`
- `Statement` now uses driver-specific string concatenation syntax internally
- Added `Statement::getFromSyntax()`, `Statement::getWhereSyntax()`, `Statement::getHavingSyntax()` accessors
- Added `WhereSyntax::jsonEncodeForSQL()` for safe JSON encoding in SQL JSON functions
- Removed `Database\Table\Alter` class — replaced by `TableHelper` and `ColumnHelper`

### Application & Runtime

- Added `Application::UnlockForWorker()` to reset application state for **FrankenPHP worker mode**
- `main.php` now wraps request handling in `frankenphp_handle_request()` with shutdown cleanup for persistent worker processes
- Web asset rewrite mapping uses `$moduleInfo->getAlias()` to match the URL generated by `Controller::getAssetPath()` — fixes 404 errors when modules use custom aliases in `package.php`

### Error Message Enhancement

- **ModuleInfo**: All 7 error messages now include the module path, version, invalid value, or expected format — previously generic messages like `'Unable to load the module.'` or `'Invalid module settings.'` gave no debugging context
- **Distributor**: `scanModule()` catch blocks now propagate the original exception message instead of swallowing it — `'Unable to load the module.'` becomes `"Unable to load module '{code}' from '{path}': {reason}"`
- **Module**: Controller validation errors now include the module code, file path, and actual class type received
- **Controller**: Closure loading errors now include the file path and method name
- **Application**: Domain matching failure now shows the FQDN that failed to match

### Rewrite Rule Enhancement

- **Domain-aware rewrite rules**: `.htaccess` now generates `RewriteCond %{HTTP_HOST}` conditions per domain, scoping all rewrite rules to their correct domain via the `RAZY_DOMAIN` environment variable
- **Alias detection**: Domain aliases are resolved in `.htaccess` via separate RewriteCond/RewriteRule pairs, mapping alias hostnames to their canonical domain
- **Wildcard domain catch-all**: Wildcard `*` domains set `RAZY_DOMAIN` as a fallback when no specific domain matches
- **Fallback routing toggle**: New `'fallback' => true|false` option in `dist.php` — when enabled (default), unmatched requests under the distributor's path prefix are forwarded to `index.php` for PHP route matching; when disabled, the server returns 404 for paths that don't match an existing file or directory
- `Application::updateRewriteRules()` restructured into two phases: domain detection (Phase 1) and per-distributor rewrite generation (Phase 2)
- Added `Application::domainToPattern()` helper for converting domain names to Apache-compatible regex patterns

### Distributor

- Added `Distributor::getFallback()` accessor for the fallback routing configuration
- Added `Distributor::executeInternalAPI()` for cross-distributor RPC via `proc_open` bridge subprocess
- Added `Distributor::getLoadedModulesInfo()` returning metadata for all loaded modules
- Added prerequisite/dependency validation: `prerequisite()`, `hasPrerequisiteConflicts()`, `getPrerequisiteConflicts()`
- Added new accessors: `getTag()`, `getIdentifier()`, `getFolderPath()`, `getModuleSourcePath()`, `hasCustomModuleSourcePath()`, `isStrict()`
- Added `loadInstalledPackages()` and `checkInstalledVersion()` for semver constraint checking

### Module & Agent

- Added **Bridge Command system** for cross-distributor command execution: `Module::addBridgeCommand()`, `Module::getBridgeCommands()`, `Module::executeBridgeCommand()`
- Added `Module::executeInternalCommand()` for internal command dispatch
- Added `Module::getThreadManager()` accessor
- Added `Module::resetForWorker()` for FrankenPHP worker mode reuse
- Refactored `Module::listen()` and `Module::createEmitter()` with closure file support
- Added `Agent::addBridgeCommand()`, `Agent::thread()` public API
- Refactored `Agent::listen()` to accept callables and auto-convert to closures

### Controller

- Added `Controller::__onBridgeCall()` lifecycle hook — called before a bridge command executes (return `false` to deny)
- Closure file loading now supports `{ClassName}.{method}.php` naming convention

### Documentation Corrections

- Fixed `webasset/` → `webassets/` naming inconsistency across all documentation (HTML docs + GitHub Wiki)
- Corrected shadow routes documentation — they are URL-matchable routes that delegate execution to another module, not hidden internal-only endpoints
- Fixed `addShadowRoute()` call signature examples to match actual 3-parameter API: `(string $route, string $moduleCode, string $path = '')`
- Expanded `Controller::getDataPath()` and `getDataPathURL()` descriptions with filesystem/URL path patterns
- Added `shadow_asset` and `alias` keys to `package.php` documentation with descriptions
- Added `data_mapping` configuration to `dist.php` documentation with cross-site data resolution explanation
- Added data path, shadow route, and data mapping sections to LLM-CAS.md

### Mailer

- Added `Mailer::sendAsync()` for asynchronous email sending via background `ThreadManager` threads
- Added `Mailer::sendPayloadFile()` static method for sending from serialized payload files
- Added internal payload serialization/deserialization for thread-safe mail delivery

### Template

- Added `Template::ReadComment()` static method to parse comment tags from template files
- Plugin loading now validates that plugin classes extend the expected base class

### Configuration

- Added YAML format support via `Configuration::saveAsYAML()`

### PackageManager

- Added `PackageManager::sortPackagesByStability()` for stability-level filtering
- Added `PackageManager::getVersionStability()` for extracting stability tags from version strings
- Added `PackageManager::versionMatches()` for semver constraint matching

---

## Removed / Deprecated

- **`Database\Table\Alter`** — removed; replaced by the more expressive `TableHelper` and `ColumnHelper` fluent builders
- **`terminal/commit.inc.php`** — removed (114 lines); module commit workflow replaced by `pack` + `publish` pipeline

---

## Infrastructure

### Composer

- Version pinned to `0.5.4`
- Added keywords for package discoverability
- Added `require-dev`: `phpunit/phpunit ^10.5`
- Added `autoload-dev`: PSR-4 mapping `Razy\Tests\` → `tests/`
- Added scripts: `test`, `test-coverage`, `cs-check`, `cs-fix`, `quality`

### LLM-CAS Templates

- Added `src/asset/prompt/LLM-CAS.md.tpl` — root-level context document template
- Added `src/asset/prompt/LLM-CAS-MODULE.md.tpl` — per-module context document template
- Added `src/asset/prompt/LLM-CAS-DISTRIBUTION.md.tpl` — per-distribution context document template

### PHPDoc Coverage

- All 119 PHP source files now include comprehensive PHPDoc annotations and inline comments

---

## Testing

Added a full PHPUnit test suite with 13 new files:

| Test File | Coverage |
|-----------|----------|
| `CollectionTest.php` | Array access, iteration, counting, exchange, append |
| `ConfigurationTest.php` | PHP/JSON/INI/YAML formats, load/save, change tracking |
| `CryptTest.php` | Encrypt/decrypt round-trips, hex encoding, tamper detection, key variations |
| `HashMapTest.php` | Push, object keys, array access, iteration, generators, mixed types |
| `RouteTest.php` | Construction, path normalization, data container, edge cases |
| `StatementTest.php` | Column standardization, search text syntax, bind parameters |
| `TableHelperTest.php` | Table/column alter builders, indexes, foreign keys, error handling |
| `TemplateTest.php` | Parameter parsing, value-by-path, assign/bind, queues, global templates |
| `YAMLTest.php` | Parse/dump, nested structures, data types, file operations, round-trips |
| `bootstrap.php` | PHPUnit bootstrap with PSR-4 autoloader |
| `test_functions.php` | Test helper functions (`Razy\guid`) |
| `test_alter_simple.php` | Standalone Table/Column helper validation script |
| `README.md` | Test suite documentation and CI setup guide |
