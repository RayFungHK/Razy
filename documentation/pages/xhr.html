<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XHR &mdash; Razy Framework</title>
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="../js/docs.js" defer></script>
</head>
<body>
  <header class="site-header"><button class="menu-toggle">&#9776;</button><a href="../index.html" class="header-logo"><span class="logo-icon">R</span> Razy <span class="header-version">v1.0-beta</span></a><nav class="header-nav"><a href="getting-started.html">Docs</a><a href="api-reference.html">API</a><a href="https://github.com/rayfunghk/razy" target="_blank">GitHub</a><button class="theme-toggle">&#x1F319;</button></nav></header>
  <aside class="sidebar"><div class="sidebar-group start-here"><div class="sidebar-group-title">&#x2B50; Start Here</div><a href="quick-start.html" class="sidebar-link">Quick Start (5 min)</a><a href="getting-started.html" class="sidebar-link">Installation</a><a href="standalone.html" class="sidebar-link">Standalone Mode</a><a href="tutorial.html" class="sidebar-link">Tutorial</a><a href="roadmap.html" class="sidebar-link">Learning Roadmap</a><a href="modules.html" class="sidebar-link">Module System</a><a href="routing.html" class="sidebar-link">Routing</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Overview</div><a href="../index.html" class="sidebar-link">Introduction</a><a href="architecture.html" class="sidebar-link">Architecture</a><a href="cli.html" class="sidebar-link">CLI Commands</a></div><div class="sidebar-group"><div class="sidebar-group-title">Module Development</div><a href="module-structure.html" class="sidebar-link">Module Structure</a><a href="controller.html" class="sidebar-link">Controller</a><a href="agent.html" class="sidebar-link">Agent</a><a href="events.html" class="sidebar-link">Event System</a><a href="cross-module-api.html" class="sidebar-link">Cross-Module API</a><a href="plugins.html" class="sidebar-link">Plugin System</a></div><div class="sidebar-group"><div class="sidebar-group-title">Routing &amp; Flow</div><a href="middleware.html" class="sidebar-link">Middleware</a><a href="pipeline.html" class="sidebar-link">Pipeline</a><a href="validation.html" class="sidebar-link">Validation</a><a href="container.html" class="sidebar-link">DI Container</a><a href="env.html" class="sidebar-link">Environment (.env)</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Data &amp; Storage</div><a href="database.html" class="sidebar-link">Database</a><a href="orm.html" class="sidebar-link">ORM</a><a href="collection.html" class="sidebar-link">Collection</a><a href="configuration.html" class="sidebar-link">Configuration</a><a href="cache.html" class="sidebar-link">Cache</a><a href="hashmap.html" class="sidebar-link">HashMap</a><a href="yaml.html" class="sidebar-link">YAML</a><a href="queue.html" class="sidebar-link">Queue</a></div><div class="sidebar-group"><div class="sidebar-group-title">Rendering</div><a href="template.html" class="sidebar-link">Template Engine</a><a href="dom.html" class="sidebar-link">DOM Builder</a><a href="simple-syntax.html" class="sidebar-link">Simple Syntax</a></div><div class="sidebar-group"><div class="sidebar-group-title">IO &amp; Communication</div><a href="httpclient.html" class="sidebar-link">HTTP Client</a><a href="xhr.html" class="sidebar-link">XHR</a><a href="sse.html" class="sidebar-link">SSE</a><a href="websocket.html" class="sidebar-link">WebSocket</a><a href="mailer.html" class="sidebar-link">Mailer</a><a href="simplified-message.html" class="sidebar-link">SimplifiedMessage</a><a href="filereader.html" class="sidebar-link">FileReader</a><a href="ftp-sftp.html" class="sidebar-link">FTP &amp; SFTP</a><a href="notification.html" class="sidebar-link">Notification</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Security</div><a href="crypt.html" class="sidebar-link">Crypt</a><a href="csrf.html" class="sidebar-link">CSRF Protection</a><a href="session.html" class="sidebar-link">Session</a><a href="oauth2.html" class="sidebar-link">OAuth2</a><a href="office365sso.html" class="sidebar-link">Office 365 SSO</a><a href="authenticator.html" class="sidebar-link">Authenticator (TOTP/HOTP)</a><a href="authmanager.html" class="sidebar-link">Auth Manager &amp; Gate</a><a href="ratelimiter.html" class="sidebar-link">Rate Limiter</a></div><div class="sidebar-group"><div class="sidebar-group-title">Observability</div><a href="logging.html" class="sidebar-link">Logging</a><a href="profiler.html" class="sidebar-link">Profiler</a><a href="error-handling.html" class="sidebar-link">Error Handling</a></div><div class="sidebar-group"><div class="sidebar-group-title">Advanced</div><a href="thread.html" class="sidebar-link">Thread &amp; ThreadManager</a><a href="worker-lifecycle.html" class="sidebar-link">Worker Lifecycle</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Deployment</div><a href="sites-configuration.html" class="sidebar-link">Sites Configuration</a><a href="packaging.html" class="sidebar-link">Packaging &amp; Distribution</a><a href="publishing.html" class="sidebar-link">Repository &amp; Publishing</a><a href="caddy-worker.html" class="sidebar-link">Caddy Worker Mode</a></div><div class="sidebar-group"><div class="sidebar-group-title">Reference</div><a href="api-reference.html" class="sidebar-link">API Reference</a><a href="moduleinfo.html" class="sidebar-link">ModuleInfo</a><a href="utilities.html" class="sidebar-link">Utility Functions</a><a href="testing.html" class="sidebar-link">Testing</a></div></aside>
  <div class="sidebar-overlay"></div>

  <main class="main-content">
    <h1>XHR</h1>
    <p>The <code>XHR</code> class is a JSON API response builder with built-in CORS and Cross-Origin Resource Policy support. It provides a structured, consistent response format for AJAX endpoints and automatically handles HTTP headers, content encoding, and output.</p>

    <h2 id="cors-constants">CORS Constants</h2>
    <table>
      <thead><tr><th>Constant</th><th>Value</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td><code>CORP_SAME_SITE</code></td><td><code>'same-site'</code></td><td>Allow requests from the same site (scheme + eTLD+1)</td></tr>
        <tr><td><code>CORP_SAME_ORIGIN</code></td><td><code>'same-origin'</code></td><td>Allow requests from the same origin only</td></tr>
        <tr><td><code>CORP_CROSS_ORIGIN</code></td><td><code>'cross-origin'</code></td><td>Allow cross-origin requests (default)</td></tr>
      </tbody>
    </table>

    <h2 id="constructor">Constructor</h2>
    <pre><code><span class="hl-kw">new</span> <span class="hl-cls">XHR</span>(<span class="hl-kw">bool</span> <span class="hl-var">$returnAsArray</span> = <span class="hl-kw">false</span>)</code></pre>
    <p>When <code>$returnAsArray</code> is <code>false</code> (default), <code>send()</code> outputs the JSON response and terminates execution. When <code>true</code>, <code>send()</code> returns the response as a PHP array instead of outputting it &mdash; useful for testing or embedding.</p>

    <h2 id="methods">Methods</h2>
    <table>
      <thead><tr><th>Method</th><th>Return</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td><code>allowOrigin(string $origin)</code></td><td><code>XHR</code></td><td>Set the <code>Access-Control-Allow-Origin</code> header. Accepts <code>'*'</code> or comma-separated origins.</td></tr>
        <tr><td><code>corp(string $type)</code></td><td><code>XHR</code></td><td>Set the Cross-Origin Resource Policy header</td></tr>
        <tr><td><code>data($dataset)</code></td><td><code>XHR</code></td><td>Set the main response content (the <code>response</code> field)</td></tr>
        <tr><td><code>set(string $name, $dataset)</code></td><td><code>XHR</code></td><td>Set a named parameter in the <code>params</code> object</td></tr>
        <tr><td><code>send(bool $success = true, string $message = '')</code></td><td><code>mixed</code></td><td>Output JSON response (or return array if <code>returnAsArray</code> is true)</td></tr>
        <tr><td><code>onComplete(callable $closure)</code></td><td><code>XHR</code></td><td>Register a callback to execute after the response is sent</td></tr>
      </tbody>
    </table>

    <h2 id="response-format">Response Format</h2>
    <p>Every response follows this JSON structure:</p>
    <pre><code>{
    <span class="hl-str">"result"</span>:    <span class="hl-kw">true</span> | <span class="hl-kw">false</span>,
    <span class="hl-str">"hash"</span>:      <span class="hl-str">"unique-request-hash"</span>,
    <span class="hl-str">"timestamp"</span>: <span class="hl-num">1739712000</span>,
    <span class="hl-str">"response"</span>:  <span class="hl-cmt">/* mixed &mdash; the main content from data() */</span>,
    <span class="hl-str">"message"</span>:   <span class="hl-str">"optional status message"</span>,
    <span class="hl-str">"params"</span>:    { <span class="hl-cmt">/* named parameters from set() */</span> }
}</code></pre>
    <p>The <code>hash</code> is a unique identifier generated per <code>XHR</code> instance. The <code>message</code> and <code>params</code> fields are only included when non-empty.</p>

    <h2 id="usage-controller">Usage in Controller</h2>
    <p>A complete example returning API data from a module route handler:</p>
    <pre><code><span class="hl-kw">use</span> <span class="hl-cls">Razy\XHR</span>;

<span class="hl-cmt">// Inside a Controller route method</span>
<span class="hl-kw">public function</span> <span class="hl-fn">apiGetUsers</span>(): <span class="hl-kw">void</span>
{
    <span class="hl-var">$xhr</span> = <span class="hl-kw">new</span> <span class="hl-cls">XHR</span>();

    <span class="hl-var">$users</span> = [
        [<span class="hl-str">'id'</span> => <span class="hl-num">1</span>, <span class="hl-str">'name'</span> => <span class="hl-str">'Alice'</span>],
        [<span class="hl-str">'id'</span> => <span class="hl-num">2</span>, <span class="hl-str">'name'</span> => <span class="hl-str">'Bob'</span>],
    ];

    <span class="hl-var">$xhr</span>-><span class="hl-fn">data</span>(<span class="hl-var">$users</span>)
        -><span class="hl-fn">set</span>(<span class="hl-str">'total'</span>, <span class="hl-fn">count</span>(<span class="hl-var">$users</span>))
        -><span class="hl-fn">set</span>(<span class="hl-str">'page'</span>, <span class="hl-num">1</span>)
        -><span class="hl-fn">send</span>(<span class="hl-kw">true</span>, <span class="hl-str">'Users retrieved'</span>);
    <span class="hl-cmt">// Outputs JSON and exits</span>
}</code></pre>
    <p>The output would be:</p>
    <pre><code>{
    <span class="hl-str">"result"</span>: <span class="hl-kw">true</span>,
    <span class="hl-str">"hash"</span>: <span class="hl-str">"a1b2c3d4"</span>,
    <span class="hl-str">"timestamp"</span>: <span class="hl-num">1739712000</span>,
    <span class="hl-str">"response"</span>: [
        { <span class="hl-str">"id"</span>: <span class="hl-num">1</span>, <span class="hl-str">"name"</span>: <span class="hl-str">"Alice"</span> },
        { <span class="hl-str">"id"</span>: <span class="hl-num">2</span>, <span class="hl-str">"name"</span>: <span class="hl-str">"Bob"</span> }
    ],
    <span class="hl-str">"message"</span>: <span class="hl-str">"Users retrieved"</span>,
    <span class="hl-str">"params"</span>: { <span class="hl-str">"total"</span>: <span class="hl-num">2</span>, <span class="hl-str">"page"</span>: <span class="hl-num">1</span> }
}</code></pre>

    <h2 id="error-response">Error Response</h2>
    <pre><code><span class="hl-var">$xhr</span> = <span class="hl-kw">new</span> <span class="hl-cls">XHR</span>();

<span class="hl-kw">try</span> {
    <span class="hl-var">$result</span> = <span class="hl-var">$this</span>-><span class="hl-fn">processOrder</span>(<span class="hl-var">$orderId</span>);
    <span class="hl-var">$xhr</span>-><span class="hl-fn">data</span>(<span class="hl-var">$result</span>)-><span class="hl-fn">send</span>(<span class="hl-kw">true</span>);
} <span class="hl-kw">catch</span> (<span class="hl-cls">Exception</span> <span class="hl-var">$e</span>) {
    <span class="hl-var">$xhr</span>-><span class="hl-fn">send</span>(<span class="hl-kw">false</span>, <span class="hl-var">$e</span>-><span class="hl-fn">getMessage</span>());
}</code></pre>

    <h2 id="cors-configuration">CORS Configuration</h2>
    <p>Set allowed origins for cross-origin requests:</p>
    <pre><code><span class="hl-var">$xhr</span> = <span class="hl-kw">new</span> <span class="hl-cls">XHR</span>();

<span class="hl-cmt">// Allow all origins</span>
<span class="hl-var">$xhr</span>-><span class="hl-fn">allowOrigin</span>(<span class="hl-str">'*'</span>);

<span class="hl-cmt">// Allow specific origins (comma-separated)</span>
<span class="hl-var">$xhr</span>-><span class="hl-fn">allowOrigin</span>(<span class="hl-str">'https://app.example.com,https://admin.example.com'</span>);

<span class="hl-cmt">// Set Cross-Origin Resource Policy</span>
<span class="hl-var">$xhr</span>-><span class="hl-fn">corp</span>(<span class="hl-cls">XHR</span>::<span class="hl-var">CORP_SAME_ORIGIN</span>);

<span class="hl-var">$xhr</span>-><span class="hl-fn">data</span>([<span class="hl-str">'status'</span> => <span class="hl-str">'ok'</span>])-><span class="hl-fn">send</span>();</code></pre>

    <h2 id="on-complete">Post-Send Callback</h2>
    <p>Use <code>onComplete()</code> to register a callback that runs after the JSON response is output &mdash; useful for logging or cleanup:</p>
    <pre><code><span class="hl-var">$xhr</span> = <span class="hl-kw">new</span> <span class="hl-cls">XHR</span>();
<span class="hl-var">$xhr</span>-><span class="hl-fn">onComplete</span>(<span class="hl-kw">function</span>() {
    <span class="hl-cmt">// Runs after response is sent, before exit</span>
    <span class="hl-fn">error_log</span>(<span class="hl-str">'API response delivered at '</span> . <span class="hl-fn">date</span>(<span class="hl-str">'c'</span>));
});

<span class="hl-var">$xhr</span>-><span class="hl-fn">data</span>([<span class="hl-str">'status'</span> => <span class="hl-str">'ok'</span>])-><span class="hl-fn">send</span>();</code></pre>

    <div class="page-nav">
      <a href="template.html"><span class="label">&larr; Previous</span><span class="title">Template Engine</span></a>
      <a href="sse.html" class="next"><span class="label">Next &rarr;</span><span class="title">SSE</span></a>
    </div>
  </main>
  <footer class="site-footer"><span>Razy Framework v1.0-beta</span><span><a href="https://github.com/rayfunghk/razy" target="_blank">GitHub</a></span></footer>
</body>
</html>
