<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSRF Protection &mdash; Razy Framework</title>
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&amp;family=JetBrains+Mono:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <script src="../js/docs.js" defer></script>
</head>
<body>
  <header class="site-header"><button class="menu-toggle">&#9776;</button><a href="../index.html" class="header-logo"><span class="logo-icon">R</span> Razy <span class="header-version">v1.0-beta</span></a><nav class="header-nav"><a href="getting-started.html">Docs</a><a href="api-reference.html">API</a><a href="https://github.com/rayfunghk/razy" target="_blank">GitHub</a><button class="theme-toggle">&#x1F319;</button></nav></header>
  <aside class="sidebar"><div class="sidebar-group start-here"><div class="sidebar-group-title">тн?Start Here</div><a href="quick-start.html" class="sidebar-link">Quick Start (5 min)</a><a href="getting-started.html" class="sidebar-link">Installation</a><a href="standalone.html" class="sidebar-link">Standalone Mode</a><a href="tutorial.html" class="sidebar-link">Tutorial</a><a href="roadmap.html" class="sidebar-link">Learning Roadmap</a><a href="modules.html" class="sidebar-link">Module System</a><a href="routing.html" class="sidebar-link">Routing</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Overview</div><a href="../index.html" class="sidebar-link">Introduction</a><a href="architecture.html" class="sidebar-link">Architecture</a><a href="cli.html" class="sidebar-link">CLI Commands</a></div><div class="sidebar-group"><div class="sidebar-group-title">Module Development</div><a href="module-structure.html" class="sidebar-link">Module Structure</a><a href="controller.html" class="sidebar-link">Controller</a><a href="agent.html" class="sidebar-link">Agent</a><a href="events.html" class="sidebar-link">Event System</a><a href="cross-module-api.html" class="sidebar-link">Cross-Module API</a><a href="plugins.html" class="sidebar-link">Plugin System</a></div><div class="sidebar-group"><div class="sidebar-group-title">Routing &amp; Flow</div><a href="middleware.html" class="sidebar-link">Middleware</a><a href="pipeline.html" class="sidebar-link">Pipeline</a><a href="validation.html" class="sidebar-link">Validation</a><a href="container.html" class="sidebar-link">DI Container</a><a href="env.html" class="sidebar-link">Environment (.env)</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Data &amp; Storage</div><a href="database.html" class="sidebar-link">Database</a><a href="orm.html" class="sidebar-link">ORM</a><a href="collection.html" class="sidebar-link">Collection</a><a href="configuration.html" class="sidebar-link">Configuration</a><a href="cache.html" class="sidebar-link">Cache</a><a href="hashmap.html" class="sidebar-link">HashMap</a><a href="yaml.html" class="sidebar-link">YAML</a><a href="queue.html" class="sidebar-link">Queue</a></div><div class="sidebar-group"><div class="sidebar-group-title">Rendering</div><a href="template.html" class="sidebar-link">Template Engine</a><a href="dom.html" class="sidebar-link">DOM Builder</a><a href="simple-syntax.html" class="sidebar-link">Simple Syntax</a></div><div class="sidebar-group"><div class="sidebar-group-title">IO &amp; Communication</div><a href="httpclient.html" class="sidebar-link">HTTP Client</a><a href="xhr.html" class="sidebar-link">XHR</a><a href="sse.html" class="sidebar-link">SSE</a><a href="websocket.html" class="sidebar-link">WebSocket</a><a href="mailer.html" class="sidebar-link">Mailer</a><a href="simplified-message.html" class="sidebar-link">SimplifiedMessage</a><a href="filereader.html" class="sidebar-link">FileReader</a><a href="ftp-sftp.html" class="sidebar-link">FTP &amp; SFTP</a><a href="notification.html" class="sidebar-link">Notification</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Security</div><a href="crypt.html" class="sidebar-link">Crypt</a><a href="csrf.html" class="sidebar-link">CSRF Protection</a><a href="session.html" class="sidebar-link">Session</a><a href="oauth2.html" class="sidebar-link">OAuth2</a><a href="office365sso.html" class="sidebar-link">Office 365 SSO</a><a href="authenticator.html" class="sidebar-link">Authenticator (TOTP/HOTP)</a><a href="authmanager.html" class="sidebar-link">Auth Manager &amp; Gate</a><a href="ratelimiter.html" class="sidebar-link">Rate Limiter</a></div><div class="sidebar-group"><div class="sidebar-group-title">Observability</div><a href="logging.html" class="sidebar-link">Logging</a><a href="profiler.html" class="sidebar-link">Profiler</a><a href="error-handling.html" class="sidebar-link">Error Handling</a></div><div class="sidebar-group"><div class="sidebar-group-title">Advanced</div><a href="thread.html" class="sidebar-link">Thread &amp; ThreadManager</a><a href="worker-lifecycle.html" class="sidebar-link">Worker Lifecycle</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Deployment</div><a href="sites-configuration.html" class="sidebar-link">Sites Configuration</a><a href="packaging.html" class="sidebar-link">Packaging &amp; Distribution</a><a href="publishing.html" class="sidebar-link">Repository &amp; Publishing</a><a href="caddy-worker.html" class="sidebar-link">Caddy Worker Mode</a></div><div class="sidebar-group"><div class="sidebar-group-title">Reference</div><a href="api-reference.html" class="sidebar-link">API Reference</a><a href="moduleinfo.html" class="sidebar-link">ModuleInfo</a><a href="utilities.html" class="sidebar-link">Utility Functions</a><a href="testing.html" class="sidebar-link">Testing</a></div></aside>
  <div class="sidebar-overlay"></div>

  <main class="main-content">
    <h1>CSRF Protection</h1>
    <p>Razy provides CSRF protection through a token manager and middleware. Tokens are stored in the session, validated with timing-safe comparison, and enforced automatically on state-changing HTTP methods.</p>

    <h2 id="quick-start">Quick Start</h2>
    <pre><code><span class="hl-kw">use</span> <span class="hl-cls">Razy\Session\Session</span>;
<span class="hl-kw">use</span> <span class="hl-cls">Razy\Session\Driver\FileDriver</span>;
<span class="hl-kw">use</span> <span class="hl-cls">Razy\Csrf\CsrfTokenManager</span>;
<span class="hl-kw">use</span> <span class="hl-cls">Razy\Csrf\CsrfMiddleware</span>;
<span class="hl-kw">use</span> <span class="hl-cls">Razy\Distributor\MiddlewarePipeline</span>;

<span class="hl-var">$session</span> = <span class="hl-kw">new</span> <span class="hl-cls">Session</span>(<span class="hl-kw">new</span> <span class="hl-cls">FileDriver</span>(<span class="hl-str">'/tmp/sessions'</span>));
<span class="hl-var">$csrf</span> = <span class="hl-kw">new</span> <span class="hl-cls">CsrfTokenManager</span>(<span class="hl-var">$session</span>);

<span class="hl-var">$pipeline</span> = <span class="hl-kw">new</span> <span class="hl-cls">MiddlewarePipeline</span>();
<span class="hl-var">$pipeline</span>-&gt;<span class="hl-fn">pipe</span>(<span class="hl-kw">new</span> <span class="hl-cls">SessionMiddleware</span>(<span class="hl-var">$session</span>));
<span class="hl-var">$pipeline</span>-&gt;<span class="hl-fn">pipe</span>(<span class="hl-kw">new</span> <span class="hl-cls">CsrfMiddleware</span>(<span class="hl-var">$csrf</span>));

<span class="hl-var">$token</span> = <span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">token</span>();</code></pre>

    <h2 id="csrf-token-manager">CsrfTokenManager</h2>
    <p>Manages CSRF tokens via the session. Tokens are 64-character hex strings generated from <code><span class="hl-fn">random_bytes</span>(<span class="hl-num">32</span>)</code>.</p>
    <pre><code><span class="hl-var">$csrf</span> = <span class="hl-kw">new</span> <span class="hl-cls">CsrfTokenManager</span>(<span class="hl-var">$session</span>);

<span class="hl-var">$token</span> = <span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">token</span>();         <span class="hl-cmt">// Get or generate token</span>
<span class="hl-var">$valid</span> = <span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">validate</span>(<span class="hl-var">$_POST</span>[<span class="hl-str">'_token'</span>]); <span class="hl-cmt">// Timing-safe check</span>
<span class="hl-var">$newToken</span> = <span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">regenerate</span>(); <span class="hl-cmt">// New token (e.g., after login)</span>
<span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">hasToken</span>();               <span class="hl-cmt">// Token exists?</span>
<span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">clearToken</span>();             <span class="hl-cmt">// Remove from session</span>
<span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">getSession</span>();             <span class="hl-cmt">// Underlying session</span></code></pre>

    <table>
      <thead>
        <tr><th>Constant</th><th>Value</th><th>Description</th></tr>
      </thead>
      <tbody>
        <tr><td><code><span class="hl-kw">SESSION_KEY</span></code></td><td><code><span class="hl-str">'_csrf_token'</span></code></td><td>Key used in session storage</td></tr>
      </tbody>
    </table>

    <h2 id="csrf-middleware">CsrfMiddleware</h2>
    <p>Validates tokens on state-changing requests (POST, PUT, PATCH, DELETE). Safe methods (GET, HEAD, OPTIONS) pass through.</p>

    <h3 id="configuration-options">Configuration Options</h3>
    <pre><code><span class="hl-var">$middleware</span> = <span class="hl-kw">new</span> <span class="hl-cls">CsrfMiddleware</span>(
    <span class="hl-fn">tokenManager</span>: <span class="hl-var">$csrf</span>,
    <span class="hl-fn">onMismatch</span>: <span class="hl-kw">function</span> (<span class="hl-kw">array</span> <span class="hl-var">$context</span>) {
        <span class="hl-kw">return</span> [<span class="hl-str">'error'</span> =&gt; <span class="hl-str">'Invalid CSRF token'</span>, <span class="hl-str">'code'</span> =&gt; <span class="hl-num">419</span>];
    },
    <span class="hl-fn">excludedRoutes</span>: [<span class="hl-str">'/api/webhook'</span>, <span class="hl-str">'/api/stripe/hook'</span>],
    <span class="hl-fn">rotateOnSuccess</span>: <span class="hl-kw">false</span>,
    <span class="hl-fn">tokenExtractor</span>: <span class="hl-kw">function</span> (<span class="hl-kw">array</span> <span class="hl-var">$context</span>) {
        <span class="hl-kw">return</span> <span class="hl-var">$context</span>[<span class="hl-str">'headers'</span>][<span class="hl-str">'x-custom-token'</span>] &rarr; <span class="hl-kw">null</span>;
    },
);</code></pre>

    <h3 id="token-extraction-order">Token Extraction Order</h3>
    <ol>
      <li>Custom <code><span class="hl-var">$tokenExtractor</span></code> closure (if provided)</li>
      <li><code><span class="hl-var">$_POST</span>[<span class="hl-str">'_token'</span>]</code> &mdash;form field</li>
      <li><code><span class="hl-var">$_SERVER</span>[<span class="hl-str">'HTTP_X_CSRF_TOKEN'</span>]</code> &mdash;HTTP header</li>
      <li><code><span class="hl-var">$context</span>[<span class="hl-str">'_token'</span>]</code> &mdash;context key</li>
    </ol>

    <h3 id="excluding-routes">Excluding Routes</h3>
    <pre><code><span class="hl-var">$middleware</span> = <span class="hl-kw">new</span> <span class="hl-cls">CsrfMiddleware</span>(
    <span class="hl-fn">tokenManager</span>: <span class="hl-var">$csrf</span>,
    <span class="hl-fn">excludedRoutes</span>: [<span class="hl-str">'/api/webhook'</span>, <span class="hl-str">'/api/stripe/hook'</span>],
);</code></pre>

    <h3 id="token-rotation">Token Rotation</h3>
    <pre><code><span class="hl-var">$middleware</span> = <span class="hl-kw">new</span> <span class="hl-cls">CsrfMiddleware</span>(
    <span class="hl-fn">tokenManager</span>: <span class="hl-var">$csrf</span>,
    <span class="hl-fn">rotateOnSuccess</span>: <span class="hl-kw">true</span>,
);</code></pre>

    <h2 id="usage-in-forms">Usage in Forms</h2>
    <pre><code>&lt;<span class="hl-kw">form</span> <span class="hl-fn">method</span>=<span class="hl-str">"POST"</span> <span class="hl-fn">action</span>=<span class="hl-str">"/profile/update"</span>&gt;
    &lt;<span class="hl-kw">input</span> <span class="hl-fn">type</span>=<span class="hl-str">"hidden"</span> <span class="hl-fn">name</span>=<span class="hl-str">"_token"</span> <span class="hl-fn">value</span>=<span class="hl-str">"&lt;?= <span class="hl-fn">htmlspecialchars</span>(<span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">token</span>()) ?&gt;"</span>&gt;
    &lt;<span class="hl-kw">input</span> <span class="hl-fn">type</span>=<span class="hl-str">"text"</span> <span class="hl-fn">name</span>=<span class="hl-str">"name"</span>&gt;
    &lt;<span class="hl-kw">button</span> <span class="hl-fn">type</span>=<span class="hl-str">"submit"</span>&gt;Save&lt;/<span class="hl-kw">button</span>&gt;
&lt;/<span class="hl-kw">form</span>&gt;</code></pre>

    <h2 id="usage-in-ajax">Usage in AJAX</h2>
    <pre><code><span class="hl-kw">const</span> <span class="hl-var">token</span> = <span class="hl-var">document</span>.<span class="hl-fn">querySelector</span>(<span class="hl-str">'meta[name="csrf-token"]'</span>)?.<span class="hl-var">content</span>;

<span class="hl-fn">fetch</span>(<span class="hl-str">'/api/data'</span>, {
    <span class="hl-fn">method</span>: <span class="hl-str">'POST'</span>,
    <span class="hl-fn">headers</span>: {
        <span class="hl-str">'Content-Type'</span>: <span class="hl-str">'application/json'</span>,
        <span class="hl-str">'X-CSRF-TOKEN'</span>: <span class="hl-var">token</span>,
    },
    <span class="hl-fn">body</span>: <span class="hl-cls">JSON</span>.<span class="hl-fn">stringify</span>({ <span class="hl-fn">name</span>: <span class="hl-str">'Alice'</span> }),
});</code></pre>

    <p>Meta tag:</p>
    <pre><code>&lt;<span class="hl-kw">meta</span> <span class="hl-fn">name</span>=<span class="hl-str">"csrf-token"</span> <span class="hl-fn">content</span>=<span class="hl-str">"&lt;?= <span class="hl-fn">htmlspecialchars</span>(<span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">token</span>()) ?&gt;"</span>&gt;</code></pre>

    <h2 id="token-mismatch-exception">TokenMismatchException</h2>
    <p>Thrown when CSRF validation fails (error code 419).</p>
    <pre><code><span class="hl-kw">use</span> <span class="hl-cls">Razy\Csrf\TokenMismatchException</span>;

<span class="hl-kw">try</span> {
    <span class="hl-kw">if</span> (!<span class="hl-var">$csrf</span>-&gt;<span class="hl-fn">validate</span>(<span class="hl-var">$submittedToken</span>)) {
        <span class="hl-kw">throw new</span> <span class="hl-cls">TokenMismatchException</span>();
    }
} <span class="hl-kw">catch</span> (<span class="hl-cls">TokenMismatchException</span> <span class="hl-var">$e</span>) {
    <span class="hl-kw">echo</span> <span class="hl-var">$e</span>-&gt;<span class="hl-fn">getMessage</span>();  <span class="hl-cmt">// 'CSRF token mismatch.'</span>
    <span class="hl-kw">echo</span> <span class="hl-var">$e</span>-&gt;<span class="hl-fn">getCode</span>();     <span class="hl-cmt">// 419</span>
}</code></pre>

    <h2 id="api-reference">API Reference</h2>

    <h3 id="api-csrf-token-manager">CsrfTokenManager</h3>
    <table>
      <thead>
        <tr><th>Method</th><th>Signature</th><th>Returns</th></tr>
      </thead>
      <tbody>
        <tr><td><code><span class="hl-fn">__construct</span></code></td><td><code>(<span class="hl-cls">SessionInterface</span> <span class="hl-var">$session</span>)</code></td><td></td></tr>
        <tr><td><code><span class="hl-fn">token</span></code></td><td><code>(): <span class="hl-kw">string</span></code></td><td>Get/generate 64-char hex token</td></tr>
        <tr><td><code><span class="hl-fn">validate</span></code></td><td><code>(<span class="hl-kw">string</span> <span class="hl-var">$submittedToken</span>): <span class="hl-kw">bool</span></code></td><td>Timing-safe comparison</td></tr>
        <tr><td><code><span class="hl-fn">regenerate</span></code></td><td><code>(): <span class="hl-kw">string</span></code></td><td>Replace and return new token</td></tr>
        <tr><td><code><span class="hl-fn">hasToken</span></code></td><td><code>(): <span class="hl-kw">bool</span></code></td><td>Token exists in session?</td></tr>
        <tr><td><code><span class="hl-fn">clearToken</span></code></td><td><code>(): <span class="hl-kw">void</span></code></td><td>Remove from session</td></tr>
        <tr><td><code><span class="hl-fn">getSession</span></code></td><td><code>(): <span class="hl-cls">SessionInterface</span></code></td><td>Underlying session</td></tr>
      </tbody>
    </table>

    <h3 id="api-csrf-middleware">CsrfMiddleware</h3>
    <table>
      <thead>
        <tr><th>Method</th><th>Signature</th><th>Returns</th></tr>
      </thead>
      <tbody>
        <tr><td><code><span class="hl-fn">__construct</span></code></td><td><code>(<span class="hl-cls">CsrfTokenManager</span>, ?<span class="hl-cls">Closure</span> <span class="hl-var">$onMismatch</span>, <span class="hl-kw">array</span> <span class="hl-var">$excludedRoutes</span>, <span class="hl-kw">bool</span> <span class="hl-var">$rotateOnSuccess</span>, ?<span class="hl-cls">Closure</span> <span class="hl-var">$tokenExtractor</span>)</code></td><td></td></tr>
        <tr><td><code><span class="hl-fn">handle</span></code></td><td><code>(<span class="hl-kw">array</span> <span class="hl-var">$context</span>, <span class="hl-cls">Closure</span> <span class="hl-var">$next</span>): <span class="hl-kw">mixed</span></code></td><td>Validates or short-circuits</td></tr>
      </tbody>
    </table>

    <table>
      <thead>
        <tr><th>Constant</th><th>Value</th><th>Description</th></tr>
      </thead>
      <tbody>
        <tr><td><code><span class="hl-kw">SAFE_METHODS</span></code></td><td><code>[<span class="hl-str">'GET'</span>, <span class="hl-str">'HEAD'</span>, <span class="hl-str">'OPTIONS'</span>]</code></td><td>Methods that bypass validation</td></tr>
        <tr><td><code><span class="hl-kw">TOKEN_FIELD</span></code></td><td><code><span class="hl-str">'_token'</span></code></td><td>POST field name</td></tr>
        <tr><td><code><span class="hl-kw">TOKEN_HEADER</span></code></td><td><code><span class="hl-str">'X-CSRF-TOKEN'</span></code></td><td>HTTP header name</td></tr>
      </tbody>
    </table>

    <h3 id="api-token-mismatch-exception">TokenMismatchException</h3>
    <p>Extends <code><span class="hl-cls">\RuntimeException</span></code> with error code <code><span class="hl-num">419</span></code>. Default message: <code><span class="hl-str">'CSRF token mismatch.'</span></code></p>

    <div class="page-nav">
      <a href="crypt.html"><span class="label">&larr; Previous</span><span class="title">Crypt</span></a>
      <a href="session.html" class="next"><span class="label">Next &rarr;</span><span class="title">Session</span></a>
    </div>
  </main>
  <footer class="site-footer"><span>Razy Framework v1.0-beta</span><span><a href="https://github.com/rayfunghk/razy" target="_blank">GitHub</a></span></footer>
</body>
</html>