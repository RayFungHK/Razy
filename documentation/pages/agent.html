<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent &mdash; Razy Framework</title>
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="../js/docs.js" defer></script>
</head><body>
  <header class="site-header"><button class="menu-toggle">&#9776;</button><a href="../index.html" class="header-logo"><span class="logo-icon">R</span> Razy <span class="header-version">v1.0-beta</span></a><nav class="header-nav"><a href="getting-started.html">Docs</a><a href="api-reference.html">API</a><a href="https://github.com/rayfunghk/razy" target="_blank">GitHub</a><button class="theme-toggle">&#x1F319;</button></nav></header>
  <aside class="sidebar"><div class="sidebar-group start-here"><div class="sidebar-group-title">&#x2B50; Start Here</div><a href="quick-start.html" class="sidebar-link">Quick Start (5 min)</a><a href="getting-started.html" class="sidebar-link">Installation</a><a href="standalone.html" class="sidebar-link">Standalone Mode</a><a href="tutorial.html" class="sidebar-link">Tutorial</a><a href="roadmap.html" class="sidebar-link">Learning Roadmap</a><a href="modules.html" class="sidebar-link">Module System</a><a href="routing.html" class="sidebar-link">Routing</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Overview</div><a href="../index.html" class="sidebar-link">Introduction</a><a href="architecture.html" class="sidebar-link">Architecture</a><a href="cli.html" class="sidebar-link">CLI Commands</a></div><div class="sidebar-group"><div class="sidebar-group-title">Module Development</div><a href="module-structure.html" class="sidebar-link">Module Structure</a><a href="controller.html" class="sidebar-link">Controller</a><a href="agent.html" class="sidebar-link">Agent</a><a href="events.html" class="sidebar-link">Event System</a><a href="cross-module-api.html" class="sidebar-link">Cross-Module API</a><a href="plugins.html" class="sidebar-link">Plugin System</a></div><div class="sidebar-group"><div class="sidebar-group-title">Routing &amp; Flow</div><a href="middleware.html" class="sidebar-link">Middleware</a><a href="pipeline.html" class="sidebar-link">Pipeline</a><a href="validation.html" class="sidebar-link">Validation</a><a href="container.html" class="sidebar-link">DI Container</a><a href="env.html" class="sidebar-link">Environment (.env)</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Data &amp; Storage</div><a href="database.html" class="sidebar-link">Database</a><a href="orm.html" class="sidebar-link">ORM</a><a href="collection.html" class="sidebar-link">Collection</a><a href="configuration.html" class="sidebar-link">Configuration</a><a href="cache.html" class="sidebar-link">Cache</a><a href="hashmap.html" class="sidebar-link">HashMap</a><a href="yaml.html" class="sidebar-link">YAML</a><a href="queue.html" class="sidebar-link">Queue</a></div><div class="sidebar-group"><div class="sidebar-group-title">Rendering</div><a href="template.html" class="sidebar-link">Template Engine</a><a href="dom.html" class="sidebar-link">DOM Builder</a><a href="simple-syntax.html" class="sidebar-link">Simple Syntax</a></div><div class="sidebar-group"><div class="sidebar-group-title">IO &amp; Communication</div><a href="httpclient.html" class="sidebar-link">HTTP Client</a><a href="xhr.html" class="sidebar-link">XHR</a><a href="sse.html" class="sidebar-link">SSE</a><a href="websocket.html" class="sidebar-link">WebSocket</a><a href="mailer.html" class="sidebar-link">Mailer</a><a href="simplified-message.html" class="sidebar-link">SimplifiedMessage</a><a href="filereader.html" class="sidebar-link">FileReader</a><a href="ftp-sftp.html" class="sidebar-link">FTP &amp; SFTP</a><a href="notification.html" class="sidebar-link">Notification</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Security</div><a href="crypt.html" class="sidebar-link">Crypt</a><a href="csrf.html" class="sidebar-link">CSRF Protection</a><a href="session.html" class="sidebar-link">Session</a><a href="oauth2.html" class="sidebar-link">OAuth2</a><a href="office365sso.html" class="sidebar-link">Office 365 SSO</a><a href="authenticator.html" class="sidebar-link">Authenticator (TOTP/HOTP)</a><a href="authmanager.html" class="sidebar-link">Auth Manager &amp; Gate</a><a href="ratelimiter.html" class="sidebar-link">Rate Limiter</a></div><div class="sidebar-group"><div class="sidebar-group-title">Observability</div><a href="logging.html" class="sidebar-link">Logging</a><a href="profiler.html" class="sidebar-link">Profiler</a><a href="error-handling.html" class="sidebar-link">Error Handling</a></div><div class="sidebar-group"><div class="sidebar-group-title">Advanced</div><a href="thread.html" class="sidebar-link">Thread &amp; ThreadManager</a><a href="worker-lifecycle.html" class="sidebar-link">Worker Lifecycle</a></div><hr class="sidebar-divider"><div class="sidebar-group"><div class="sidebar-group-title">Deployment</div><a href="sites-configuration.html" class="sidebar-link">Sites Configuration</a><a href="packaging.html" class="sidebar-link">Packaging &amp; Distribution</a><a href="publishing.html" class="sidebar-link">Repository &amp; Publishing</a><a href="caddy-worker.html" class="sidebar-link">Caddy Worker Mode</a></div><div class="sidebar-group"><div class="sidebar-group-title">Reference</div><a href="api-reference.html" class="sidebar-link">API Reference</a><a href="moduleinfo.html" class="sidebar-link">ModuleInfo</a><a href="utilities.html" class="sidebar-link">Utility Functions</a><a href="testing.html" class="sidebar-link">Testing</a></div></aside>
  <div class="sidebar-overlay"></div>

  <main class="main-content">
    <h1>Agent</h1>
    <p>The <code>Agent</code> object is injected into your controller's <code>__onInit()</code> and <code>__onLoad()</code> hooks. Use it to register routes, events, API commands, bridge commands, and configure module behaviour.</p>

    <h2 id="route-registration">Route Registration</h2>

    <h3 id="addroute"><code>addRoute(mixed $route, $path = null): static</code></h3>
    <p>Register a URL route pattern mapped to a controller closure file. The framework matches the URL left-to-right against registered patterns.</p>

    <h4>Pattern Syntax</h4>
    <table><thead><tr><th>Token</th><th>Matches</th><th>Example</th></tr></thead><tbody>
      <tr><td><code>:d</code></td><td>Digits only</td><td><code>/user/:d</code> &rarr; <code>/user/42</code></td></tr>
      <tr><td><code>:a</code></td><td>Any non-slash characters</td><td><code>/post/:a</code> &rarr; <code>/post/abc-123</code></td></tr>
      <tr><td><code>:w</code></td><td>Word characters (a-zA-Z, 0-9, _)</td><td><code>/tag/:w</code> &rarr; <code>/tag/my_tag</code></td></tr>
      <tr><td><code>:W</code></td><td>Non-word characters</td><td><code>/sep/:W</code> &rarr; <code>/sep/--..!</code></td></tr>
      <tr><td><code>:D</code></td><td>Non-digit characters</td><td><code>/code/:D</code> &rarr; <code>/code/abc</code></td></tr>
      <tr><td><code>:[regex]</code></td><td>Custom character class</td><td><code>:[a-z0-9-]</code> &rarr; custom match</td></tr>
      <tr><td><code>{min,max}</code></td><td>Length constraint</td><td><code>:a{3,50}</code> &mdash; 3-50 non-slash characters</td></tr>
    </tbody></table>

<pre><code><span class="hl-cmt">// Single route</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">addRoute</span>(<span class="hl-str">'/'</span>, <span class="hl-str">'index'</span>);
<span class="hl-var">$agent</span>-><span class="hl-fn">addRoute</span>(<span class="hl-str">'/user/:d'</span>, <span class="hl-str">'showUser'</span>);
<span class="hl-var">$agent</span>-><span class="hl-fn">addRoute</span>(<span class="hl-str">'/post/:a{3,50}'</span>, <span class="hl-str">'showPost'</span>);

<span class="hl-cmt">// Array syntax for multiple routes</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">addRoute</span>([
    <span class="hl-str">'/'</span>           => <span class="hl-str">'index'</span>,
    <span class="hl-str">'/create'</span>     => <span class="hl-str">'createForm'</span>,
    <span class="hl-str">'/edit/:d'</span>    => <span class="hl-str">'editForm'</span>,
    <span class="hl-str">'/file/:*'</span>    => <span class="hl-str">'serveFile'</span>,
]);</code></pre>
    <div class="callout callout-info"><strong>Closure files:</strong> The <code>$path</code> maps to a PHP file in <code>controller/</code>. E.g. <code>'showUser'</code> &rarr; <code>controller/{module_code}.showUser.php</code>.</div>

    <h3 id="addlazyroute"><code>addLazyRoute(mixed $route, mixed $path = null): static</code></h3>
    <p>Register a lazily-resolved route. The handler file is only loaded when the route is actually matched.</p>
    <div class="callout callout-tip"><strong>Use for:</strong> Large modules with many routes where loading all handlers upfront would hurt startup performance.</div>

    <h4>Method Prefix in Nested Arrays</h4>
    <p>When using nested arrays, HTTP method prefixes can be applied at any level. A method on a parent key is <strong>inherited</strong> by all descendants unless overridden:</p>
<pre><code><span class="hl-cmt">// Parent-level method &mdash; all children inherit POST</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">addLazyRoute</span>([<span class="hl-str">'POST api'</span> => [
    <span class="hl-str">'fetch'</span>  => <span class="hl-str">'fetch'</span>,   <span class="hl-cmt">// POST api/fetch</span>
    <span class="hl-str">'add'</span>    => <span class="hl-str">'add'</span>,     <span class="hl-cmt">// POST api/add</span>
]]);

<span class="hl-cmt">// Child override &mdash; child prefix takes precedence</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">addLazyRoute</span>([<span class="hl-str">'GET api'</span> => [
    <span class="hl-str">'list'</span>        => <span class="hl-str">'list'</span>,    <span class="hl-cmt">// GET  api/list  (inherited)</span>
    <span class="hl-str">'POST create'</span> => <span class="hl-str">'create'</span>,  <span class="hl-cmt">// POST api/create (overridden)</span>
]]);</code></pre>
    <p>The method prefix is stripped from the key before building the handler file path. See <a href="routing.html#method-filtering">Routing &mdash; HTTP Method Filtering</a> for the full reference.</p>

    <h3 id="addshadowroute"><code>addShadowRoute(string $route, string $moduleCode, string $path = ''): static</code></h3>
    <p>Redirect a matched route to another module's handler. The URL stays the same but processing is delegated.</p>
<pre><code><span class="hl-cmt">// Delegate /admin routes to admin_panel module</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">addShadowRoute</span>(<span class="hl-str">'/admin'</span>, <span class="hl-str">'admin_panel'</span>, <span class="hl-str">'dashboard'</span>);</code></pre>

    <h3 id="addscript"><code>addScript($route, $path = null): self</code></h3>
    <p>Add a script-mode route. Scripts execute after normal routing and can produce additional output (e.g. analytics, footers).</p>

    <h2 id="events">Event Listening</h2>

    <h3 id="listen"><code>listen(mixed $event, null|string|callable $path = null): bool|array</code></h3>
    <p>Register event listener(s). When another module fires the event via <code>trigger()</code>, your callback runs.</p>
<pre><code><span class="hl-cmt">// Single event</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">listen</span>(<span class="hl-str">'user.login'</span>, <span class="hl-str">'handleUserLogin'</span>);

<span class="hl-cmt">// Multiple events</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">listen</span>([
    <span class="hl-str">'user.login'</span>  => <span class="hl-str">'handleLogin'</span>,
    <span class="hl-str">'user.logout'</span> => <span class="hl-str">'handleLogout'</span>,
    <span class="hl-str">'order.placed'</span> => <span class="hl-str">'handleOrder'</span>,
]);</code></pre>

    <h2 id="api-commands">API &amp; Bridge</h2>

    <h3 id="addapicommand"><code>addAPICommand(mixed $command, ?string $path = null): static</code></h3>
    <p>Register a command that other modules can call via <code>$this-&gt;api('your_module')-&gt;commandName()</code>.</p>
<pre><code><span class="hl-var">$agent</span>-><span class="hl-fn">addAPICommand</span>(<span class="hl-str">'getUser'</span>, <span class="hl-str">'apiGetUser'</span>);
<span class="hl-var">$agent</span>-><span class="hl-fn">addAPICommand</span>(<span class="hl-str">'validateEmail'</span>, <span class="hl-str">'apiValidateEmail'</span>);

<span class="hl-cmt">// Array syntax</span>
<span class="hl-var">$agent</span>-><span class="hl-fn">addAPICommand</span>([
    <span class="hl-str">'getUser'</span>       => <span class="hl-str">'apiGetUser'</span>,
    <span class="hl-str">'updateProfile'</span> => <span class="hl-str">'apiUpdateProfile'</span>,
]);</code></pre>

    <h3 id="addbridgecommand"><code>addBridgeCommand(mixed $command, ?string $path = null): static</code></h3>
    <p>Register commands for cross-distributor (cross-domain) communication via the internal bridge.</p>

    <h2 id="module-interaction">Module Interaction</h2>

    <h3 id="await"><code>await(string $moduleCode, callable $caller): static</code></h3>
    <p>Register a callback to execute when a specific module becomes ready. Useful when your module depends on another module's initialization.</p>
<pre><code><span class="hl-var">$agent</span>-><span class="hl-fn">await</span>(<span class="hl-str">'auth_module'</span>, <span class="hl-kw">function</span>(<span class="hl-cls">ModuleInfo</span> <span class="hl-var">$authInfo</span>) {
    <span class="hl-cmt">// auth_module is now ready, safe to use its API</span>
});</code></pre>

    <h3 id="thread"><code>thread(): ThreadManager</code></h3>
    <p>Get the module's <code>ThreadManager</code> for spawning background processes. See <a href="thread.html">Thread &amp; ThreadManager</a>.</p>

    <h3 id="middleware"><code>middleware(MiddlewareInterface|Closure ...$middleware): static</code></h3>
    <p>Register one or more middleware at module level. Middleware run on every route handled by this module.</p>
    <pre><code><span class="hl-kw">use</span> <span class="hl-cls">Razy\Middleware\MiddlewareInterface</span>;

<span class="hl-cmt">// Class-based middleware</span>
<span class="hl-var">$agent</span>-&gt;<span class="hl-fn">middleware</span>(<span class="hl-kw">new</span> <span class="hl-cls">AuthMiddleware</span>(), <span class="hl-kw">new</span> <span class="hl-cls">CorsMiddleware</span>());

<span class="hl-cmt">// Closure middleware</span>
<span class="hl-var">$agent</span>-&gt;<span class="hl-fn">middleware</span>(<span class="hl-kw">function</span> (<span class="hl-var">$request</span>, <span class="hl-var">$next</span>) {
    <span class="hl-cmt">// pre-processing</span>
    <span class="hl-var">$response</span> = <span class="hl-var">$next</span>(<span class="hl-var">$request</span>);
    <span class="hl-cmt">// post-processing</span>
    <span class="hl-kw">return</span> <span class="hl-var">$response</span>;
});</code></pre>

    <h3 id="group"><code>group(string $prefix, Closure $callback): static</code></h3>
    <p>Register a group of routes with a shared URL prefix. The callback receives a <code>RouteGroup</code> instance for defining nested routes and middleware.</p>
    <pre><code><span class="hl-var">$agent</span>-&gt;<span class="hl-fn">group</span>(<span class="hl-str">'/api/v1'</span>, <span class="hl-kw">function</span> (<span class="hl-cls">RouteGroup</span> <span class="hl-var">$group</span>) {
    <span class="hl-var">$group</span>-&gt;<span class="hl-fn">middleware</span>(<span class="hl-kw">new</span> <span class="hl-cls">AuthMiddleware</span>());
    <span class="hl-var">$group</span>-&gt;<span class="hl-fn">namePrefix</span>(<span class="hl-str">'api.'</span>);
    <span class="hl-var">$group</span>-&gt;<span class="hl-fn">addRoute</span>(<span class="hl-str">'/users'</span>, <span class="hl-str">'api/users'</span>);
    <span class="hl-var">$group</span>-&gt;<span class="hl-fn">addRoute</span>(<span class="hl-str">'/posts'</span>, <span class="hl-str">'api/posts'</span>);

    <span class="hl-cmt">// Nested groups</span>
    <span class="hl-var">$group</span>-&gt;<span class="hl-fn">group</span>(<span class="hl-str">'/admin'</span>, <span class="hl-kw">function</span> (<span class="hl-cls">RouteGroup</span> <span class="hl-var">$sub</span>) {
        <span class="hl-var">$sub</span>-&gt;<span class="hl-fn">middleware</span>(<span class="hl-kw">new</span> <span class="hl-cls">AdminMiddleware</span>());
        <span class="hl-var">$sub</span>-&gt;<span class="hl-fn">addRoute</span>(<span class="hl-str">'/dashboard'</span>, <span class="hl-str">'admin/dashboard'</span>);
    });
});</code></pre>

    <div class="page-nav">
      <a href="controller.html"><span class="label">&larr; Previous</span><span class="title">Controller</span></a>
      <a href="routing.html" class="next"><span class="label">Next &rarr;</span><span class="title">Routing</span></a>
    </div>
  </main>
  <footer class="site-footer"><span>Razy Framework v1.0-beta</span><span><a href="https://github.com/rayfunghk/razy" target="_blank">GitHub</a></span></footer>
</body></html>
